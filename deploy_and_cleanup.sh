#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É, –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ª—ñ–¥—ñ–≤ —Ç–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä—ñ
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: bash deploy_and_cleanup.sh

set -e  # –í–∏–π—Ç–∏ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ

echo "========================================"
echo "üöÄ DEPLOY & CLEANUP"
echo "========================================"
echo ""

# –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –ø—Ä–æ–µ–∫—Ç—É
cd /home/pro-part-agent/htdocs/agent.pro-part.online/propart-real-estate-hub

# 1. –û–Ω–æ–≤–∏—Ç–∏ –∫–æ–¥ –∑ Git
echo "1Ô∏è‚É£ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É –∑ GitHub..."
git pull origin main
echo "‚úÖ –ö–æ–¥ –æ–Ω–æ–≤–ª–µ–Ω–æ"
echo ""

# 2. –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ—Ö –ª—ñ–¥—ñ–≤
echo "2Ô∏è‚É£ –í–∏–¥–∞–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö –ª—ñ–¥—ñ–≤..."
echo "‚ö†Ô∏è  –£–í–ê–ì–ê! –í—Å—ñ –ª—ñ–¥–∏ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ!"
read -p "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏? (y/N): " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]
then
    venv/bin/python3 delete_all_leads.py
    echo "‚úÖ –õ—ñ–¥–∏ –≤–∏–¥–∞–ª–µ–Ω–æ"
else
    echo "‚ùå –í–∏–¥–∞–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ"
fi
echo ""

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫
echo "3Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É..."
pkill -f "python.*run.py" || echo "–°—Ç–∞—Ä–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
sleep 2

nohup venv/bin/python run.py > logs/propart.log 2>&1 &
sleep 4

# 4. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
echo ""
echo "4Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É..."
if ps aux | grep "python.*run.py" | grep -v grep > /dev/null; then
    echo "‚úÖ –î–æ–¥–∞—Ç–æ–∫ –∑–∞–ø—É—â–µ–Ω–æ"
    ps aux | grep "python.*run.py" | grep -v grep | head -2
else
    echo "‚ùå –î–æ–¥–∞—Ç–æ–∫ –ù–ï –∑–∞–ø—É—â–µ–Ω–∏–π!"
    echo "–õ–æ–≥–∏:"
    tail -20 logs/propart.log
    exit 1
fi

# 5. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–æ—Ä—Ç
echo ""
if netstat -tulpn | grep 8090 > /dev/null; then
    echo "‚úÖ –ü–æ—Ä—Ç 8090 –≤—ñ–¥–∫—Ä–∏—Ç–∏–π"
else
    echo "‚ùå –ü–æ—Ä—Ç 8090 –ù–ï –≤—ñ–¥–∫—Ä–∏—Ç–∏–π!"
fi

echo ""
echo "========================================"
echo "‚úÖ –ì–û–¢–û–í–û!"
echo "========================================"
echo ""
echo "üåê –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ: https://agent.pro-part.online"
echo ""

