#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะพะฝะพะฒะปะตะฝะฝั ััะฐััััะฒ ะฝะฐ ัะตัะฒะตัั

echo "๐ ะะฝะพะฒะปะตะฝะฝั ััะฐััััะฒ ะฝะฐ ัะตัะฒะตัั..."
echo ""

# ะจะปัั ะดะพ ะฟัะพะตะบัั ะฝะฐ ัะตัะฒะตัั (ะทะฐะผัะฝััั ะฝะฐ ะฒะฐั ัะปัั)
PROJECT_PATH="/home/pro-part-agent/htdocs/agent.pro-part.online/propart-real-estate-hub"

cd "$PROJECT_PATH" || exit 1

# 1. Git pull
echo "1๏ธโฃ ะะฝะพะฒะปะตะฝะฝั ะบะพะดั ะท Git..."
git pull origin main
echo "โ ะะพะด ะพะฝะพะฒะปะตะฝะพ"
echo ""

# 2. ะะตัะตะทะฐะฟััะบ ะดะพะดะฐัะบั (ัะบัะพ ะฒะธะบะพัะธััะพะฒัััััั systemd)
echo "2๏ธโฃ ะะตัะตะทะฐะฟััะบ ะดะพะดะฐัะบั..."
if systemctl is-active --quiet propart; then
    sudo systemctl restart propart
    echo "โ ะะพะดะฐัะพะบ ะฟะตัะตะทะฐะฟััะตะฝะพ ัะตัะตะท systemd"
elif [ -f "venv/bin/python" ]; then
    # ะฏะบัะพ ะทะฐะฟััะตะฝะพ ัะตัะตะท nohup
    pkill -f "python.*run.py" || true
    sleep 2
    nohup venv/bin/python run.py > logs/propart.log 2>&1 &
    echo "โ ะะพะดะฐัะพะบ ะฟะตัะตะทะฐะฟััะตะฝะพ"
else
    echo "โ๏ธ ะะต ะฒะดะฐะปะพัั ะฒะธะทะฝะฐัะธัะธ ัะฟะพััะฑ ะทะฐะฟััะบั ะดะพะดะฐัะบั"
fi

# 3. ะะตัะตะทะฐะฟััะบ Nginx (ัะพะฑ ะพะฝะพะฒะธัะธ ััะฐัะธัะฝั ัะฐะนะปะธ)
echo "3๏ธโฃ ะะตัะตะทะฐะฟััะบ Nginx..."
sudo systemctl reload nginx || sudo systemctl restart nginx
echo "โ Nginx ะฟะตัะตะทะฐะฟััะตะฝะพ"
echo ""

# 4. ะะตัะตะฒััะบะฐ
echo "4๏ธโฃ ะะตัะตะฒััะบะฐ ััะฐัััั..."
sleep 2
if curl -s -o /dev/null -w "%{http_code}" http://localhost:8090 > /dev/null 2>&1 || curl -s -o /dev/null -w "%{http_code}" https://agent.pro-part.online > /dev/null 2>&1; then
    echo "โ ะะพะดะฐัะพะบ ะฟัะฐััั"
else
    echo "โ๏ธ ะะตัะตะฒัััะต ะปะพะณะธ: tail -f logs/propart.log"
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ ะะฝะพะฒะปะตะฝะฝั ะทะฐะฒะตััะตะฝะพ!"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ ะัะดะบัะธะนัะต: https://agent.pro-part.online/dashboard"
echo ""
echo "๐ก ะะต ะทะฐะฑัะดััะต ะพัะธััะธัะธ ะบะตั ะฑัะฐัะทะตัะฐ (Ctrl+Shift+R)"
echo ""

