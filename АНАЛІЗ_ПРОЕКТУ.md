# üîç –ö–û–ú–ü–õ–ï–ö–°–ù–ò–ô –ê–ù–ê–õ–Ü–ó –ü–†–û–ï–ö–¢–£ PRO-PART HUB

**–î–∞—Ç–∞ –∞–Ω–∞–ª—ñ–∑—É:** 1 –∂–æ–≤—Ç–Ω—è 2025  
**–í–µ—Ä—Å—ñ—è –ø—Ä–æ–µ–∫—Ç—É:** 1.0.0  
**–ê–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏:** Backend (Flask), –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö (PostgreSQL), HubSpot API —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è

---

## üìä –ó–ê–ì–ê–õ–¨–ù–ò–ô –û–ì–õ–Ø–î

### ‚úÖ –©–æ –ø—Ä–∞—Ü—é—î –¥–æ–±—Ä–µ:
1. ‚úÖ PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–∏—Ö –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞ —Ç–∞ –ø—Ä–∞—Ü—é—î
2. ‚úÖ HubSpot API –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ
3. ‚úÖ –ë–∞–∑–æ–≤–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞
4. ‚úÖ CRUD –æ–ø–µ—Ä–∞—Ü—ñ—ó –¥–ª—è –ª—ñ–¥—ñ–≤ –ø—Ä–∞—Ü—é—é—Ç—å
5. ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π (admin/agent) –ø—Ä–∞—Ü—é—î
6. ‚úÖ –ì–µ–π–º–∏—Ñ—ñ–∫–∞—Ü—ñ—è (points, levels) —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞
7. ‚úÖ –ë–∞–∑–æ–≤–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ HubSpot –ø—Ä–∞—Ü—é—î

### ‚ö†Ô∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç—É:
- **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:** 4
- **–õ—ñ–¥—ñ–≤:** 4
- **–¢–∞–±–ª–∏—Ü—å –ë–î:** 4 (user, lead, note_status, activity)
- **Commits –≤ –∫–æ–¥—ñ:** 21
- **Rollbacks –≤ –∫–æ–¥—ñ:** 11
- **API endpoints:** ~30+

---

## üö® –ö–†–ò–¢–ò–ß–ù–Ü –ü–†–û–ë–õ–ï–ú–ò (–ü–†–Ü–û–†–ò–¢–ï–¢ 1)

### 1. **–í–Ü–î–°–£–¢–ù–Ü–°–¢–¨ –û–ë–†–û–ë–ö–ò –ü–û–ú–ò–õ–û–ö –ë–ê–ó–ò –î–ê–ù–ò–•**
**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# app.py, —Ä—è–¥–æ–∫ 19
app.config['SQLALCHEMY_DATABASE_URI'] = 'postgresql:///real_estate_agents'
```
- –ù–µ–º–∞—î –æ–±—Ä–æ–±–∫–∏ connection errors
- –ù–µ–º–∞—î connection pooling –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
- –í—ñ–¥—Å—É—Ç–Ω—è –æ–±—Ä–æ–±–∫–∞ timeouts
- –ñ–æ—Ä—Å—Ç–∫–æ –∑–∞–∫–æ–¥–æ–≤–∞–Ω–∏–π URI

**–†–∏–∑–∏–∫–∏:**
- üí• –°–∏—Å—Ç–µ–º–∞ –≤–ø–∞–¥–µ –ø—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –ë–î
- üí• –ù–µ–º–∞—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ reconnect
- üí• Connection leaks –º–æ–∂—É—Ç—å –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ deadlock

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
```python
# –î–æ–¥–∞—Ç–∏ –¥–æ app.py
app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv(
    'DATABASE_URL', 
    'postgresql://localhost/real_estate_agents'
)
app.config['SQLALCHEMY_ENGINE_OPTIONS'] = {
    'pool_size': 10,
    'pool_recycle': 3600,
    'pool_pre_ping': True,
    'max_overflow': 20,
    'connect_args': {
        'connect_timeout': 10,
        'options': '-c statement_timeout=30000'
    }
}

# –î–æ–¥–∞—Ç–∏ error handler
@app.errorhandler(Exception)
def handle_db_error(error):
    db.session.rollback()
    app.logger.error(f"Database error: {error}")
    return jsonify({'error': 'Database error'}), 500
```

---

### 2. **–í–Ü–î–°–£–¢–ù–Ü–°–¢–¨ –õ–û–ì–£–í–ê–ù–ù–Ø**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ–º–∞—î —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ print() statements
- –ù–µ–º–∞—î —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –ª–æ–≥—ñ–≤ –∑–∞ —Ä—ñ–≤–Ω—è–º–∏ (INFO, WARNING, ERROR)
- –ù–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥—Å—Ç–µ–∂–∏—Ç–∏ –ø—Ä–æ–±–ª–µ–º–∏ –≤ production

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
```python
# –î–æ–¥–∞—Ç–∏ logging.py
import logging
from logging.handlers import RotatingFileHandler
import os

def setup_logging(app):
    if not app.debug:
        if not os.path.exists('logs'):
            os.mkdir('logs')
        
        file_handler = RotatingFileHandler(
            'logs/propart.log', 
            maxBytes=10240000, 
            backupCount=10
        )
        file_handler.setFormatter(logging.Formatter(
            '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'
        ))
        file_handler.setLevel(logging.INFO)
        app.logger.addHandler(file_handler)
        app.logger.setLevel(logging.INFO)
        app.logger.info('ProPart Hub startup')

# –í app.py:
from logging_config import setup_logging
setup_logging(app)

# –ó–∞–º—ñ–Ω–∏—Ç–∏ –≤—Å—ñ print() –Ω–∞:
app.logger.info("...")
app.logger.warning("...")
app.logger.error("...")
```

---

### 3. **–í–Ü–î–°–£–¢–ù–Ü–°–¢–¨ HUBSPOT API RATE LIMITING**
**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# app.py, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
setInterval(function() {
    console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ HubSpot...');
    // ...
}, 30000); // 30 —Å–µ–∫—É–Ω–¥
```

**–†–∏–∑–∏–∫–∏:**
- üí• HubSpot –º–∞—î –ª—ñ–º—ñ—Ç 100 requests/10 seconds
- üí• –ü—Ä–∏ –±–∞–≥–∞—Ç—å–æ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞—Ö - 429 Too Many Requests
- üí• –ù–µ–º–∞—î retry logic –∑ exponential backoff

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
```python
# –î–æ–¥–∞—Ç–∏ hubspot_rate_limiter.py
import time
from functools import wraps
import requests

class RateLimiter:
    def __init__(self, max_calls, period):
        self.max_calls = max_calls
        self.period = period
        self.calls = []
    
    def __call__(self, func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            now = time.time()
            self.calls = [c for c in self.calls if c > now - self.period]
            
            if len(self.calls) >= self.max_calls:
                sleep_time = self.period - (now - self.calls[0])
                app.logger.warning(f"Rate limit reached, sleeping {sleep_time}s")
                time.sleep(sleep_time)
            
            self.calls.append(time.time())
            
            # Retry logic
            max_retries = 3
            for attempt in range(max_retries):
                try:
                    return func(*args, **kwargs)
                except requests.exceptions.HTTPError as e:
                    if e.response.status_code == 429:
                        retry_after = int(e.response.headers.get('Retry-After', 60))
                        app.logger.warning(f"429 error, retry after {retry_after}s")
                        time.sleep(retry_after)
                    elif attempt == max_retries - 1:
                        raise
                except Exception as e:
                    if attempt == max_retries - 1:
                        raise
                    time.sleep(2 ** attempt)
            
        return wrapper

# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
rate_limiter = RateLimiter(max_calls=90, period=10)

@rate_limiter
def sync_lead_from_hubspot(lead):
    # ...
```

---

### 4. **–í–Ü–î–°–£–¢–ù–Ü–°–¢–¨ –ú–Ü–ì–†–ê–¶–Ü–ô–ù–û–á –°–ò–°–¢–ï–ú–ò**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è db.create_all() –∑–∞–º—ñ—Å—Ç—å –º—ñ–≥—Ä–∞—Ü—ñ–π
- –ù–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥—Å—Ç–µ–∂–∏—Ç–∏ –∑–º—ñ–Ω–∏ —Å—Ö–µ–º–∏ –ë–î
- –°–∫–ª–∞–¥–Ω–æ —Ä–æ–±–∏—Ç–∏ rollback –∑–º—ñ–Ω
- –ü—Ä–æ–±–ª–µ–º–∏ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ production –ë–î

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
```bash
# –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ Alembic
pip install alembic

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ Alembic
alembic init migrations

# –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä—à—É –º—ñ–≥—Ä–∞—Ü—ñ—é
alembic revision --autogenerate -m "Initial migration"

# –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—é
alembic upgrade head
```

```python
# –î–æ–¥–∞—Ç–∏ –¥–æ requirements.txt
alembic==1.12.1
```

---

### 5. **–°–õ–ê–ë–ö–ê –ë–ï–ó–ü–ï–ö–ê**
**–ü—Ä–æ–±–ª–µ–º–∏:**
1. **SECRET_KEY –º–∞—î —Å–ª–∞–±–∫–∏–π fallback:**
```python
app.config['SECRET_KEY'] = os.getenv('SECRET_KEY', 'your-secret-key-here')
```

2. **–í—ñ–¥—Å—É—Ç–Ω—è CSRF –∑–∞—Ö–∏—Å—Ç**
3. **–ù–µ–º–∞—î rate limiting –¥–ª—è login**
4. **Password hashing –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Werkzeug –∑–∞–º—ñ—Å—Ç—å bcrypt**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
```python
# 1. –í–∏–ø—Ä–∞–≤–∏—Ç–∏ SECRET_KEY
import secrets

SECRET_KEY = os.getenv('SECRET_KEY')
if not SECRET_KEY:
    raise ValueError("SECRET_KEY must be set in .env file")
app.config['SECRET_KEY'] = SECRET_KEY

# 2. –î–æ–¥–∞—Ç–∏ CSRF –∑–∞—Ö–∏—Å—Ç
from flask_wtf.csrf import CSRFProtect
csrf = CSRFProtect(app)

# 3. –î–æ–¥–∞—Ç–∏ rate limiting
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

limiter = Limiter(
    app=app,
    key_func=get_remote_address,
    default_limits=["200 per day", "50 per hour"]
)

@app.route('/login', methods=['POST'])
@limiter.limit("5 per minute")
def login():
    # ...

# 4. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ bcrypt
from flask_bcrypt import Bcrypt
bcrypt = Bcrypt(app)

# –í User model:
def set_password(self, password):
    self.password_hash = bcrypt.generate_password_hash(password).decode('utf-8')

def check_password(self, password):
    return bcrypt.check_password_hash(self.password_hash, password)
```

```python
# –î–æ–¥–∞—Ç–∏ –¥–æ requirements.txt
Flask-WTF==1.2.1
Flask-Limiter==3.5.0
Flask-Bcrypt==1.0.1
```

---

## ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–Ü –ü–†–û–ë–õ–ï–ú–ò (–ü–†–Ü–û–†–ò–¢–ï–¢ 2)

### 6. **–í–Ü–î–°–£–¢–ù–Ü–°–¢–¨ –í–ê–õ–Ü–î–ê–¶–Ü–á –î–ê–ù–ò–• –ù–ê BACKEND**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ç—ñ–ª—å–∫–∏ –Ω–∞ frontend
- Backend –ø—Ä–∏–π–º–∞—î –±—É–¥—å-—è–∫—ñ –¥–∞–Ω—ñ
- –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å SQL injection —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ –¥–∞–Ω—ñ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
```python
# –î–æ–¥–∞—Ç–∏ validators.py
from marshmallow import Schema, fields, validate, ValidationError

class LeadSchema(Schema):
    deal_name = fields.Str(required=True, validate=validate.Length(min=2, max=100))
    email = fields.Email(required=True)
    phone = fields.Str(required=True, validate=validate.Regexp(r'^\+?[1-9]\d{1,14}$'))
    budget = fields.Str(validate=validate.OneOf(['–¥–æ 200–∫', '200–∫‚Äì500–∫', '500–∫‚Äì1–º–ª–Ω', '1–º–ª–Ω+']))
    status = fields.Str(validate=validate.OneOf(['new', 'contacted', 'qualified', 'closed']))

lead_schema = LeadSchema()

# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ routes:
@app.route('/add_lead', methods=['POST'])
@login_required
def add_lead():
    try:
        data = lead_schema.load(request.json)
    except ValidationError as err:
        return jsonify({'errors': err.messages}), 400
    # ...
```

---

### 7. **N+1 QUERY –ü–†–û–ë–õ–ï–ú–ê**
**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –í dashboard route
leads = Lead.query.all()
for lead in leads:
    agent = User.query.get(lead.agent_id)  # N+1 query!
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
```python
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ eager loading
from sqlalchemy.orm import joinedload

leads = Lead.query.options(joinedload(Lead.agent)).all()

# –ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ relationship
class Lead(db.Model):
    # ...
    agent = db.relationship('User', backref='leads', lazy='joined')
```

---

### 8. **–í–Ü–î–°–£–¢–ù–Ü–°–¢–¨ –ü–ê–ì–Ü–ù–ê–¶–Ü–á**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í—Å—ñ –ª—ñ–¥–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –æ–¥—Ä–∞–∑—É
- –ü—Ä–∏ –≤–µ–ª–∏–∫—ñ–π –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –ª—ñ–¥—ñ–≤ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –±—É–¥–µ –ø–æ–≤—ñ–ª—å–Ω–æ—é
- –í–µ–ª–∏–∫—ñ SQL –∑–∞–ø–∏—Ç–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
```python
@app.route('/dashboard')
@login_required
def dashboard():
    page = request.args.get('page', 1, type=int)
    per_page = 20
    
    if current_user.role == 'admin':
        pagination = Lead.query.order_by(Lead.created_at.desc()).paginate(
            page=page, per_page=per_page, error_out=False
        )
    else:
        pagination = Lead.query.filter_by(agent_id=current_user.id)\
            .order_by(Lead.created_at.desc())\
            .paginate(page=page, per_page=per_page, error_out=False)
    
    leads = pagination.items
    # ...
```

---

### 9. **–í–Ü–î–°–£–¢–ù–Ü–°–¢–¨ –Ü–ù–î–ï–ö–°–Ü–í –ë–î**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ–º–∞—î —ñ–Ω–¥–µ–∫—Å—ñ–≤ –¥–ª—è –ø–æ–ª—ñ–≤, —â–æ —á–∞—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –≤ –ø–æ—à—É–∫—É
- –ü–æ–≤—ñ–ª—å–Ω—ñ –∑–∞–ø–∏—Ç–∏ –ø—Ä–∏ –≤–µ–ª–∏–∫—ñ–π –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
```sql
-- –î–æ–¥–∞—Ç–∏ —ñ–Ω–¥–µ–∫—Å–∏ —á–µ—Ä–µ–∑ –º—ñ–≥—Ä–∞—Ü—ñ—é
CREATE INDEX idx_lead_agent_id ON lead(agent_id);
CREATE INDEX idx_lead_status ON lead(status);
CREATE INDEX idx_lead_created_at ON lead(created_at);
CREATE INDEX idx_lead_hubspot_contact_id ON lead(hubspot_contact_id);
CREATE INDEX idx_lead_hubspot_deal_id ON lead(hubspot_deal_id);
CREATE INDEX idx_user_username ON "user"(username);
CREATE INDEX idx_user_email ON "user"(email);
CREATE INDEX idx_note_status_lead_id ON note_status(lead_id);
CREATE INDEX idx_activity_lead_id ON activity(lead_id);
```

---

### 10. **–í–Ü–î–°–£–¢–ù–Ü–°–¢–¨ –ö–ï–®–£–í–ê–ù–ù–Ø**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–æ–∂–µ–Ω –∑–∞–ø–∏—Ç –¥–æ dashboard —Ä–æ–±–∏—Ç—å SQL –∑–∞–ø–∏—Ç–∏
- –ù–µ–º–∞—î –∫–µ—à—É–≤–∞–Ω–Ω—è –¥–ª—è –º–µ—Ç—Ä–∏–∫
- –ü–æ–≤—Ç–æ—Ä–Ω—ñ –∑–∞–ø–∏—Ç–∏ –¥–æ HubSpot API

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
```python
# –î–æ–¥–∞—Ç–∏ Flask-Caching
from flask_caching import Cache

cache = Cache(app, config={
    'CACHE_TYPE': 'redis',
    'CACHE_REDIS_URL': os.getenv('REDIS_URL', 'redis://localhost:6379/0')
})

@app.route('/dashboard')
@login_required
@cache.cached(timeout=60, key_prefix='dashboard_{current_user.id}')
def dashboard():
    # ...

# –Ü–Ω–≤–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–µ—à—É –ø—Ä–∏ –∑–º—ñ–Ω—ñ –¥–∞–Ω–∏—Ö
@app.route('/add_lead', methods=['POST'])
@login_required
def add_lead():
    # ...
    cache.delete(f'dashboard_{current_user.id}')
```

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–á –î–õ–Ø –ü–û–ö–†–ê–©–ï–ù–ù–Ø (–ü–†–Ü–û–†–ò–¢–ï–¢ 3)

### 11. **–î–û–î–ê–¢–ò BACKGROUND TASKS**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ HubSpot –±–ª–æ–∫—É—î HTTP –∑–∞–ø–∏—Ç
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —á–µ–∫–∞—î, –ø–æ–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
```python
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ Celery
from celery import Celery

celery = Celery(
    app.name,
    broker=os.getenv('CELERY_BROKER_URL', 'redis://localhost:6379/0')
)

@celery.task
def sync_lead_to_hubspot_task(lead_id):
    with app.app_context():
        lead = Lead.query.get(lead_id)
        sync_lead_from_hubspot(lead)

# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
@app.route('/add_lead', methods=['POST'])
@login_required
def add_lead():
    lead = Lead(...)
    db.session.add(lead)
    db.session.commit()
    
    # Async sync
    sync_lead_to_hubspot_task.delay(lead.id)
    
    return jsonify({'success': True})
```

---

### 12. **–î–û–î–ê–¢–ò HEALTHCHECK ENDPOINTS**
```python
@app.route('/health')
def health():
    checks = {
        'database': check_database(),
        'hubspot': check_hubspot(),
        'redis': check_redis()
    }
    
    status = 'healthy' if all(checks.values()) else 'unhealthy'
    status_code = 200 if status == 'healthy' else 503
    
    return jsonify({
        'status': status,
        'checks': checks
    }), status_code

def check_database():
    try:
        db.session.execute('SELECT 1')
        return True
    except:
        return False

def check_hubspot():
    try:
        if hubspot_client:
            # Simple API call
            hubspot_client.crm.contacts.basic_api.get_page(limit=1)
            return True
        return False
    except:
        return False
```

---

### 13. **–î–û–î–ê–¢–ò API –î–û–ö–£–ú–ï–ù–¢–ê–¶–Ü–Æ**
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:**
```python
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ Flask-RESTX –∞–±–æ Flask-Swagger
from flask_restx import Api, Resource, fields

api = Api(app, version='1.0', title='ProPart Hub API',
    description='API –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ª—ñ–¥–∞–º–∏')

lead_model = api.model('Lead', {
    'id': fields.Integer(readonly=True),
    'deal_name': fields.String(required=True),
    'email': fields.String(required=True),
    'phone': fields.String(required=True),
    'budget': fields.String(),
    'status': fields.String(),
})

@api.route('/api/leads')
class LeadList(Resource):
    @api.doc('list_leads')
    @api.marshal_list_with(lead_model)
    def get(self):
        '''List all leads'''
        return Lead.query.all()
```

---

### 14. **–î–û–î–ê–¢–ò UNIT TESTS**
```python
# tests/test_models.py
import unittest
from app import app, db, User, Lead

class UserModelTest(unittest.TestCase):
    def setUp(self):
        app.config['TESTING'] = True
        app.config['SQLALCHEMY_DATABASE_URI'] = 'postgresql:///test_db'
        self.app = app.test_client()
        db.create_all()
    
    def tearDown(self):
        db.session.remove()
        db.drop_all()
    
    def test_password_hashing(self):
        user = User(username='test', email='test@test.com', role='agent')
        user.set_password('password123')
        self.assertTrue(user.check_password('password123'))
        self.assertFalse(user.check_password('wrongpassword'))
    
    def test_add_points(self):
        user = User(username='test', email='test@test.com', role='agent', points=0)
        user.add_points(100)
        self.assertEqual(user.points, 100)
        self.assertEqual(user.level, 'bronze')
```

---

### 15. **–î–û–î–ê–¢–ò ENVIRONMENT CONFIGS**
```python
# config.py
import os

class Config:
    SECRET_KEY = os.getenv('SECRET_KEY')
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    
class DevelopmentConfig(Config):
    DEBUG = True
    SQLALCHEMY_DATABASE_URI = 'postgresql:///real_estate_agents_dev'
    
class ProductionConfig(Config):
    DEBUG = False
    SQLALCHEMY_DATABASE_URI = os.getenv('DATABASE_URL')
    SQLALCHEMY_ENGINE_OPTIONS = {
        'pool_size': 10,
        'pool_recycle': 3600,
        'pool_pre_ping': True
    }
    
class TestingConfig(Config):
    TESTING = True
    SQLALCHEMY_DATABASE_URI = 'postgresql:///real_estate_agents_test'

# –í app.py:
config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'testing': TestingConfig
}

env = os.getenv('FLASK_ENV', 'development')
app.config.from_object(config[env])
```

---

## üìã –ü–õ–ê–ù –î–Ü–ô (ROADMAP)

### –¢–µ—Ä–º—ñ–Ω–æ–≤–æ (1-2 —Ç–∏–∂–Ω—ñ):
1. ‚úÖ –î–æ–¥–∞—Ç–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è
2. ‚úÖ –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫ –ë–î
3. ‚úÖ –î–æ–¥–∞—Ç–∏ rate limiting –¥–ª—è HubSpot API
4. ‚úÖ –í–∏–ø—Ä–∞–≤–∏—Ç–∏ –±–µ–∑–ø–µ–∫—É (SECRET_KEY, CSRF, bcrypt)
5. ‚úÖ –î–æ–¥–∞—Ç–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é –¥–∞–Ω–∏—Ö –Ω–∞ backend

### –í–∞–∂–ª–∏–≤–æ (2-4 —Ç–∏–∂–Ω—ñ):
6. ‚úÖ –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ Alembic –¥–ª—è –º—ñ–≥—Ä–∞—Ü—ñ–π
7. ‚úÖ –î–æ–¥–∞—Ç–∏ —ñ–Ω–¥–µ–∫—Å–∏ –ë–î
8. ‚úÖ –í–∏–ø—Ä–∞–≤–∏—Ç–∏ N+1 queries
9. ‚úÖ –î–æ–¥–∞—Ç–∏ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—é
10. ‚úÖ –î–æ–¥–∞—Ç–∏ –∫–µ—à—É–≤–∞–Ω–Ω—è (Redis)

### –ë–∞–∂–∞–Ω–æ (1-2 –º—ñ—Å—è—Ü—ñ):
11. ‚úÖ –î–æ–¥–∞—Ç–∏ Celery –¥–ª—è background tasks
12. ‚úÖ –î–æ–¥–∞—Ç–∏ healthcheck endpoints
13. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç–∏ unit tests
14. ‚úÖ –î–æ–¥–∞—Ç–∏ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é
15. ‚úÖ –î–æ–¥–∞—Ç–∏ monitoring (Sentry, Prometheus)

---

## üéØ –í–ò–°–ù–û–í–ö–ò

### –°–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏ –ø—Ä–æ–µ–∫—Ç—É:
‚úÖ –î–æ–±—Ä–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π –∫–æ–¥  
‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Å—É—á–∞—Å–Ω–∏—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—ñ–≤  
‚úÖ HubSpot —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –ø—Ä–∞—Ü—é—î  
‚úÖ –ë–∞–∑–æ–≤–∏–π —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π  

### –°–ª–∞–±–∫—ñ –º—ñ—Å—Ü—è:
‚ùå –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –ª–æ–≥—É–≤–∞–Ω–Ω—è —Ç–∞ monitoring  
‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—è –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫  
‚ùå –ü—Ä–æ–±–ª–µ–º–∏ –∑ –±–µ–∑–ø–µ–∫–æ—é  
‚ùå –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Ç–µ—Å—Ç—ñ–≤  
‚ùå –ü—Ä–æ–±–ª–µ–º–∏ –∑ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—é  

### –ó–∞–≥–∞–ª—å–Ω–∞ –æ—Ü—ñ–Ω–∫–∞:
**6/10** - –ü—Ä–æ–µ–∫—Ç –ø—Ä–∞—Ü—é—î, –∞–ª–µ –ø–æ—Ç—Ä–µ–±—É—î —Å–µ—Ä–π–æ–∑–Ω–∏—Ö –¥–æ–æ–ø—Ä–∞—Ü—é–≤–∞–Ω—å –¥–ª—è production –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:
üö® **–ù–ï –ó–ê–ü–£–°–ö–ê–¢–ò –í PRODUCTION** –±–µ–∑ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ö–æ—á–∞ –± –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å (–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 1).

---

## üìû –ö–û–ù–¢–ê–ö–¢–ò –î–õ–Ø –ü–ò–¢–ê–ù–¨

–Ø–∫—â–æ —î –ø–∏—Ç–∞–Ω–Ω—è —â–æ–¥–æ —Ü—å–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É –∞–±–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞ –∑ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—î—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π, –∑–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—å –¥–æ —Ç–µ—Ö–Ω—ñ—á–Ω–æ–≥–æ –∫–µ—Ä—ñ–≤–Ω–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç—É.

**–î–∞—Ç–∞:** 1 –∂–æ–≤—Ç–Ω—è 2025  
**–í–µ—Ä—Å—ñ—è –¥–æ–∫—É–º–µ–Ω—Ç—É:** 1.0

