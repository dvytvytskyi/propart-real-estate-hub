{% extends "base.html" %}

{% block title %}Користувачі - ProPart Real Estate Hub{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <a href="{{ url_for('dashboard') }}" class="sidebar-brand">
            <div class="sidebar-brand-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="sidebar-brand-text">
                <span class="sidebar-brand-title">ProPart Real Estate Hub</span>
                <span class="sidebar-brand-subtitle">v1.0.0</span>
            </div>
        </a>
    </div>
    
    <div class="sidebar-content">
        <div class="sidebar-group">
            <ul class="sidebar-menu">
                <li class="sidebar-menu-item">
                    <a href="{{ url_for('dashboard') }}" class="sidebar-menu-button">
                        <i class="fas fa-chart-line"></i>
                        <span>Дашборд</span>
                    </a>
                </li>
                <li class="sidebar-menu-item">
                    <a href="{{ url_for('add_lead') }}" class="sidebar-menu-button sidebar-add-lead">
                        <i class="fas fa-user-plus"></i>
                        <span>Додати лід</span>
                    </a>
                </li>
                <li class="sidebar-menu-item">
                    <a href="{{ url_for('profile') }}" class="sidebar-menu-button">
                        <i class="fas fa-user-circle"></i>
                        <span>Профіль</span>
                    </a>
                </li>
                {% if current_user.role == 'admin' %}
                <li class="sidebar-menu-item">
                    <a href="{{ url_for('admin_verification') }}" class="sidebar-menu-button">
                        <i class="fas fa-check-circle"></i>
                        <span>Верифікація</span>
                    </a>
                </li>
                <li class="sidebar-menu-item">
                    <a href="{{ url_for('admin_users') }}" class="sidebar-menu-button active">
                        <i class="fas fa-users-cog"></i>
                        <span>Користувачі</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
    
    <div class="sidebar-group">
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item">
                <a href="{{ url_for('logout') }}" class="sidebar-menu-button">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Вийти</span>
                </a>
            </li>
        </ul>
    </div>
    
    <div class="sidebar-rail"></div>
</div>

<div class="main-content" id="mainContent">
    <div class="main-header">
        <div style="display: flex; align-items: center;">
            <button class="sidebar-toggle d-md-none me-3" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <i class="fas fa-users-cog" style="color: var(--sidebar-primary); font-size: 1.5rem;"></i>
                <h1 class="mb-0">Управління користувачами</h1>
            </div>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('register') }}" class="btn btn-primary btn-sm">
                <i class="fas fa-user-plus me-1"></i> Додати користувача
            </a>
        </div>
    </div>
    
    <div class="content-area">
        <!-- Статистичні картки -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="card stats-card">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>{{ users|length }}</h4>
                            <p>Всього користувачів</p>
                        </div>
                        <div>
                            <i class="fas fa-users fa-2x" style="opacity: 0.8; color: #94a3b8;"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card stats-card">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>{{ users|selectattr('is_active')|list|length }}</h4>
                            <p>Активних</p>
                        </div>
                        <div>
                            <i class="fas fa-check-circle fa-2x" style="opacity: 0.8; color: #94a3b8;"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card stats-card">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>{{ users|selectattr('role', 'equalto', 'agent')|list|length }}</h4>
                            <p>Агентів</p>
                        </div>
                        <div>
                            <i class="fas fa-user-tie fa-2x" style="opacity: 0.8; color: #94a3b8;"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card stats-card">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</h4>
                            <p>Адміністраторів</p>
                        </div>
                        <div>
                            <i class="fas fa-user-shield fa-2x" style="opacity: 0.8; color: #94a3b8;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Таблиця користувачів -->
        <div class="form-container">
            <div class="form-header">
                <div class="form-title">
                    <i class="fas fa-list"></i>
                    <h3>Список користувачів ({{ users|length }})</h3>
                </div>
            </div>
            <div class="form-content">
                <div class="leads-table-wrapper">
                    <table class="leads-table">
                        <thead>
                            <tr>
                                <th class="col-deal">
                                    <i class="fas fa-user"></i>
                                    <span>Користувач</span>
                                </th>
                                <th class="col-agent">
                                    <i class="fas fa-envelope"></i>
                                    <span>Email</span>
                                </th>
                                <th class="col-status">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>Роль</span>
                                </th>
                                <th class="col-budget">
                                    <i class="fas fa-toggle-on"></i>
                                    <span>Статус</span>
                                </th>
                                <th class="col-updated">
                                    <i class="fas fa-clock"></i>
                                    <span>Останній вхід</span>
                                </th>
                                <th class="col-updated">
                                    <i class="fas fa-chart-bar"></i>
                                    <span>Статистика</span>
                                </th>
                                <th class="col-actions">
                                    <i class="fas fa-cogs"></i>
                                    <span>Дії</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr class="lead-row">
                                <td class="col-deal">
                                    <div class="agent-cell">
                                        <i class="fas fa-user-circle"></i>
                                        <span>
                                            {{ user.username }}
                                            {% if user.is_verified %}
                                                <i class="fas fa-check-circle" style="color: #10b981; font-size: 0.75rem; margin-left: 0.25rem;" title="Верифікований"></i>
                                            {% endif %}
                                            {% if user.is_account_locked() %}
                                                <i class="fas fa-lock" style="color: #ef4444; font-size: 0.75rem; margin-left: 0.25rem;" title="Заблокований"></i>
                                            {% endif %}
                                        </span>
                                    </div>
                                </td>
                                <td class="col-agent">{{ user.email }}</td>
                                <td class="col-status">
                                    {% if user.role == 'admin' %}
                                        <span class="status-badge" style="background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;">
                                            <i class="fas fa-user-shield"></i>
                                            <span>Адміністратор</span>
                                        </span>
                                    {% else %}
                                        <span class="status-badge" style="background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd;">
                                            <i class="fas fa-user-tie"></i>
                                            <span>Агент</span>
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="col-budget">
                                    {% if user.is_active %}
                                        <span class="status-badge" style="background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1;">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Активний</span>
                                        </span>
                                    {% else %}
                                        <span class="status-badge" style="background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;">
                                            <i class="fas fa-times-circle"></i>
                                            <span>Деактивований</span>
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="col-updated">
                                    {% if user.last_login %}
                                        {{ user.last_login.strftime('%d %B %Y %H:%M') }}
                                    {% else %}
                                        <span style="color: var(--sidebar-text-muted);">Ніколи</span>
                                    {% endif %}
                                </td>
                                <td class="col-updated">
                                    <div style="font-size: 0.875rem; color: var(--sidebar-text-muted);">
                                        Лідів: <strong style="color: var(--sidebar-text);">{{ user.total_leads }}</strong> | 
                                        Угод: <strong style="color: var(--sidebar-text);">{{ user.closed_deals }}</strong> | 
                                        Рівень: <strong style="color: var(--sidebar-text);">{{ user.get_level_display_name() }}</strong>
                                    </div>
                                </td>
                                <td class="col-actions">
                                    <div class="lead-actions">
                                        {% if user.id != current_user.id %}
                                            <button class="action-btn {% if user.is_active %}warning{% else %}success{% endif %}" 
                                                    onclick="toggleUserStatus({{ user.id }})" 
                                                    title="{% if user.is_active %}Деактивувати{% else %}Активувати{% endif %}">
                                                <i class="fas fa-{% if user.is_active %}ban{% else %}check{% endif %}"></i>
                                            </button>
                                            
                                            {% if user.is_account_locked() %}
                                                <button class="action-btn info" 
                                                        onclick="unlockUser({{ user.id }})" 
                                                        title="Розблокувати">
                                                    <i class="fas fa-unlock"></i>
                                                </button>
                                            {% endif %}
                                            
                                            <button class="action-btn danger" 
                                                    onclick="deleteUser({{ user.id }}, '{{ user.username }}')" 
                                                    title="Видалити">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% else %}
                                            <span style="color: var(--sidebar-text-muted); font-size: 0.875rem;">Це ви</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    sidebar.classList.toggle('open');
    mainContent.classList.toggle('sidebar-open');
}

function toggleUserStatus(userId) {
    fetch(`/admin/users/${userId}/toggle_status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Помилка при зміні статусу користувача', 'error');
    });
}

function unlockUser(userId) {
    if (!confirm('Ви впевнені, що хочете розблокувати цього користувача?')) {
        return;
    }
    
    fetch(`/admin/users/${userId}/unlock`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Помилка при розблокуванні користувача', 'error');
    });
}

function deleteUser(userId, username) {
    if (!confirm(`Ви впевнені, що хочете видалити користувача "${username}"? Цю дію неможливо скасувати!`)) {
        return;
    }
    
    fetch(`/admin/users/${userId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Помилка при видаленні користувача', 'error');
    });
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle';
    
    notification.innerHTML = `
        <i class="fas ${icon} notification-icon"></i>
        <div class="notification-content">${message}</div>
        <button class="notification-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
        <div class="notification-progress"></div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}
</script>
{% endblock %}
