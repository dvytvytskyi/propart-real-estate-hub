{% extends "base.html" %}

{% block title %}–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ - ProPart Real Estate Hub{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <a href="{{ url_for('dashboard') }}" class="sidebar-brand">
            <div class="sidebar-brand-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="sidebar-brand-text">
                <span class="sidebar-brand-title">ProPart Real Estate Hub</span>
                <span class="sidebar-brand-subtitle">v1.0.0</span>
            </div>
        </a>
    </div>
    
    <div class="sidebar-content">
        <div class="sidebar-group">
            <ul class="sidebar-menu">
                <li class="sidebar-menu-item">
                    <a href="{{ url_for('dashboard') }}" class="sidebar-menu-button">
                        <i class="fas fa-chart-line"></i>
                        <span>–î–∞—à–±–æ—Ä–¥</span>
                    </a>
                </li>
                <li class="sidebar-menu-item">
                    <a href="{{ url_for('add_lead') }}" class="sidebar-menu-button sidebar-add-lead">
                        <i class="fas fa-user-plus"></i>
                        <span>–î–æ–¥–∞—Ç–∏ –ª—ñ–¥</span>
                    </a>
                </li>
                <li class="sidebar-menu-item">
                    <a href="{{ url_for('profile') }}" class="sidebar-menu-button">
                        <i class="fas fa-user-circle"></i>
                        <span>–ü—Ä–æ—Ñ—ñ–ª—å</span>
                    </a>
                </li>
                {% if current_user.role == 'admin' %}
                <li class="sidebar-menu-item">
                    <a href="{{ url_for('admin_verification') }}" class="sidebar-menu-button">
                        <i class="fas fa-check-circle"></i>
                        <span>–í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è</span>
                    </a>
                </li>
                <li class="sidebar-menu-item">
                    <a href="{{ url_for('admin_users') }}" class="sidebar-menu-button active">
                        <i class="fas fa-users-cog"></i>
                        <span>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
    
    <div class="sidebar-group">
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item">
                <a href="{{ url_for('logout') }}" class="sidebar-menu-button">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>–í–∏–π—Ç–∏</span>
                </a>
            </li>
        </ul>
    </div>
    
    <div class="sidebar-rail"></div>
</div>

<div class="main-content" id="mainContent">
    <div class="main-header">
        <div style="display: flex; align-items: center;">
            <button class="sidebar-toggle d-md-none me-3" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <i class="fas fa-users-cog" style="color: var(--sidebar-primary); font-size: 1.5rem;"></i>
                <h1 class="mb-0">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</h1>
            </div>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('register') }}" class="btn btn-primary btn-sm">
                <i class="fas fa-user-plus me-1"></i> –î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            </a>
        </div>
    </div>
    
    <div class="content-area">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω—ñ –∫–∞—Ä—Ç–∫–∏ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="card stats-card">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>{{ users|length }}</h4>
                            <p>–í—Å—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</p>
                        </div>
                        <div>
                            <i class="fas fa-users fa-2x" style="opacity: 0.8; color: #94a3b8;"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card stats-card">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>{{ users|selectattr('is_active')|list|length }}</h4>
                            <p>–ê–∫—Ç–∏–≤–Ω–∏—Ö</p>
                        </div>
                        <div>
                            <i class="fas fa-check-circle fa-2x" style="opacity: 0.8; color: #94a3b8;"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card stats-card">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>{{ users|selectattr('role', 'equalto', 'agent')|list|length }}</h4>
                            <p>–ê–≥–µ–Ω—Ç—ñ–≤</p>
                        </div>
                        <div>
                            <i class="fas fa-user-tie fa-2x" style="opacity: 0.8; color: #94a3b8;"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card stats-card">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</h4>
                            <p>–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤</p>
                        </div>
                        <div>
                            <i class="fas fa-user-shield fa-2x" style="opacity: 0.8; color: #94a3b8;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ -->
        <div class="form-container">
            <div class="form-header">
                <div class="form-title">
                    <i class="fas fa-list"></i>
                    <h3>–°–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ ({{ users|length }})</h3>
                </div>
            </div>
            <div class="form-content">
                <div class="leads-table-wrapper">
                    <table class="leads-table">
                        <thead>
                            <tr>
                                <th class="col-deal">
                                    <i class="fas fa-user"></i>
                                    <span>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</span>
                                </th>
                                <th class="col-agent">
                                    <i class="fas fa-envelope"></i>
                                    <span>Email</span>
                                </th>
                                <th class="col-status">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>–†–æ–ª—å</span>
                                </th>
                                <th class="col-budget">
                                    <i class="fas fa-toggle-on"></i>
                                    <span>–°—Ç–∞—Ç—É—Å</span>
                                </th>
                                <th class="col-updated">
                                    <i class="fas fa-clock"></i>
                                    <span>–û—Å—Ç–∞–Ω–Ω—ñ–π –≤—Ö—ñ–¥</span>
                                </th>
                                <th class="col-updated">
                                    <i class="fas fa-chart-bar"></i>
                                    <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                                </th>
                                <th class="col-budget">
                                    <i class="fas fa-percent"></i>
                                    <span>–ö–æ–º—ñ—Å—ñ—è</span>
                                </th>
                                <th class="col-actions">
                                    <i class="fas fa-cogs"></i>
                                    <span>–î—ñ—ó</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr class="lead-row">
                                <td class="col-deal">
                                    <div class="agent-cell">
                                        <i class="fas fa-user-circle"></i>
                                        <span>
                                            {{ user.username }}
                                            {% if user.is_verified %}
                                                <i class="fas fa-check-circle" style="color: #10b981; font-size: 0.75rem; margin-left: 0.25rem;" title="–í–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π"></i>
                                            {% endif %}
                                            {% if user.is_account_locked() %}
                                                <i class="fas fa-lock" style="color: #ef4444; font-size: 0.75rem; margin-left: 0.25rem;" title="–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π"></i>
                                            {% endif %}
                                        </span>
                                    </div>
                                </td>
                                <td class="col-agent">{{ user.email }}</td>
                                <td class="col-status">
                                    {% if user.role == 'admin' %}
                                        <span class="status-badge" style="background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;">
                                            <i class="fas fa-user-shield"></i>
                                            <span>–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                                        </span>
                                    {% else %}
                                        <span class="status-badge" style="background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd;">
                                            <i class="fas fa-user-tie"></i>
                                            <span>–ê–≥–µ–Ω—Ç</span>
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="col-budget">
                                    {% if user.is_active %}
                                        <span class="status-badge" style="background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1;">
                                            <i class="fas fa-check-circle"></i>
                                            <span>–ê–∫—Ç–∏–≤–Ω–∏–π</span>
                                        </span>
                                    {% else %}
                                        <span class="status-badge" style="background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;">
                                            <i class="fas fa-times-circle"></i>
                                            <span>–î–µ–∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∏–π</span>
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="col-updated">
                                    {% if user.last_login %}
                                        {{ user.last_login.strftime('%d %B %Y %H:%M') }}
                                    {% else %}
                                        <span style="color: var(--sidebar-text-muted);">–ù—ñ–∫–æ–ª–∏</span>
                                    {% endif %}
                                </td>
                                <td class="col-updated">
                                    <div style="font-size: 0.875rem; color: var(--sidebar-text-muted);">
                                        –õ—ñ–¥—ñ–≤: <strong style="color: var(--sidebar-text);">{{ user.total_leads }}</strong> | 
                                        –£–≥–æ–¥: <strong style="color: var(--sidebar-text);">{{ user.closed_deals }}</strong> | 
                                        –†—ñ–≤–µ–Ω—å: <strong style="color: var(--sidebar-text);">{{ user.get_level_display_name() }}</strong>
                                    </div>
                                </td>
                                <td class="col-budget">
                                    <div id="commission-{{ user.id }}" style="font-size: 0.875rem;">
                                        <strong style="color: var(--sidebar-primary); font-size: 1rem;">{{ user.commission or 0 }}%</strong>
                                    </div>
                                </td>
                                <td class="col-actions">
                                    <div class="lead-actions">
                                        {% if user.id != current_user.id %}
                                            <button class="action-btn info" 
                                                    onclick="openCommissionModal({{ user.id }}, '{{ user.username }}', {{ user.commission or 0 }})" 
                                                    title="–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∫–æ–º—ñ—Å—ñ—é">
                                                <i class="fas fa-dollar-sign"></i>
                                            </button>
                                            
                                            <button class="action-btn {% if user.doc_count > 0 %}success{% else %}danger{% endif %}" 
                                                    data-user-id="{{ user.id }}"
                                                    data-doc-button="true"
                                                    onclick="openDocumentsModal({{ user.id }}, '{{ user.username }}')" 
                                                    title="–î–æ–∫—É–º–µ–Ω—Ç–∏ ({{ user.doc_count }})">
                                                <i class="fas fa-file-alt"></i>
                                            </button>
                                            
                                            <button class="action-btn {% if user.is_active %}warning{% else %}success{% endif %}" 
                                                    onclick="toggleUserStatus({{ user.id }})" 
                                                    title="{% if user.is_active %}–î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏{% else %}–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏{% endif %}">
                                                <i class="fas fa-{% if user.is_active %}ban{% else %}check{% endif %}"></i>
                                            </button>
                                            
                                            {% if user.is_account_locked() %}
                                                <button class="action-btn info" 
                                                        onclick="unlockUser({{ user.id }})" 
                                                        title="–†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏">
                                                    <i class="fas fa-unlock"></i>
                                                </button>
                                            {% endif %}
                                            
                                            <button class="action-btn danger" 
                                                    onclick="deleteUser({{ user.id }}, '{{ user.username }}')" 
                                                    title="–í–∏–¥–∞–ª–∏—Ç–∏">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% else %}
                                            <span style="color: var(--sidebar-text-muted); font-size: 0.875rem;">–¶–µ –≤–∏</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–º—ñ—Å—ñ—ó -->
<div id="commissionModal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeCommissionModal()"></div>
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>
                <i class="fas fa-dollar-sign" style="color: var(--sidebar-primary);"></i>
                –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∫–æ–º—ñ—Å—ñ—é
            </h3>
            <button class="modal-close" onclick="closeCommissionModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 1.5rem; color: var(--sidebar-text-muted);">
                –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –≤—ñ–¥—Å–æ—Ç–æ–∫ –∫–æ–º—ñ—Å—ñ—ó –¥–ª—è –∞–≥–µ–Ω—Ç–∞ <strong id="modalUsername"></strong>
            </p>
            
            <div class="form-group">
                <label for="commissionInput" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                    –ö–æ–º—ñ—Å—ñ—è (%)
                </label>
                <div style="position: relative;">
                    <input 
                        type="number" 
                        id="commissionInput" 
                        class="form-control" 
                        placeholder="–í–≤–µ–¥—ñ—Ç—å –≤—ñ–¥—Å–æ—Ç–æ–∫ (0-100)" 
                        min="0" 
                        max="100" 
                        step="0.1"
                        style="padding-right: 3rem;"
                    >
                    <span style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--sidebar-text-muted); font-weight: 500;">%</span>
                </div>
                <small style="display: block; margin-top: 0.5rem; color: var(--sidebar-text-muted);">
                    –í–≤–µ–¥—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è –≤—ñ–¥ 0 –¥–æ 100
                </small>
            </div>
            
            <!-- –®–≤–∏–¥–∫—ñ –∫–Ω–æ–ø–∫–∏ -->
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                <button class="btn btn-sm btn-outline-secondary" onclick="setCommissionValue(0)">0%</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="setCommissionValue(2)">2%</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="setCommissionValue(3)">3%</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="setCommissionValue(5)">5%</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="setCommissionValue(10)">10%</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="setCommissionValue(15)">15%</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCommissionModal()">
                –°–∫–∞—Å—É–≤–∞—Ç–∏
            </button>
            <button class="btn btn-primary" onclick="saveCommission()">
                <i class="fas fa-save"></i>
                –ó–±–µ—Ä–µ–≥—Ç–∏
            </button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ -->
<div id="documentsModal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeDocumentsModal()"></div>
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3>
                <i class="fas fa-file-alt" style="color: var(--sidebar-primary);"></i>
                –î–æ–∫—É–º–µ–Ω—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            </h3>
            <button class="modal-close" onclick="closeDocumentsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 1.5rem;">
                <p style="color: var(--sidebar-text-muted); margin-bottom: 0.5rem;">
                    –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: <strong id="documentsUsername" style="color: var(--sidebar-text);"></strong>
                </p>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç—É -->
            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 0.95rem; color: var(--sidebar-text);">
                    <i class="fas fa-upload"></i> –î–æ–¥–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç
                </h4>
                <form id="uploadDocumentForm" enctype="multipart/form-data">
                    <div style="position: relative;">
                        <input 
                            type="file" 
                            id="documentFile" 
                            name="file" 
                            style="display: none;"
                            accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt"
                            onchange="updateFileName()"
                        >
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('documentFile').click()" style="white-space: nowrap;">
                                <i class="fas fa-folder-open"></i> –í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª
                            </button>
                            <span id="selectedFileName" style="flex: 1; color: var(--sidebar-text-muted); font-size: 0.875rem; font-style: italic;">
                                –§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ
                            </span>
                            <button type="button" id="clearFileBtn" class="btn btn-sm btn-outline-secondary" onclick="clearSelectedFile()" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <small style="display: block; margin-top: 0.75rem; color: var(--sidebar-text-muted);">
                        <i class="fas fa-info-circle"></i> –ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏: PDF, DOC, DOCX, JPG, PNG, TXT (–º–∞–∫—Å. 10MB)
                    </small>
                </form>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ -->
            <div id="documentsList">
                <h4 style="margin: 0 0 1rem 0; font-size: 0.95rem; color: var(--sidebar-text);">
                    <i class="fas fa-list"></i> –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤
                </h4>
                <div id="documentsListContent">
                    <div style="text-align: center; padding: 2rem; color: var(--sidebar-text-muted);">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p style="margin-top: 1rem;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDocumentsModal()">
                <i class="fas fa-times"></i>
                –°–∫–∞—Å—É–≤–∞—Ç–∏
            </button>
            <button class="btn btn-primary" onclick="saveDocumentChanges()">
                <i class="fas fa-save"></i>
                Save Changes
            </button>
        </div>
    </div>
</div>

<script>
let currentUserId = null;
let currentDocumentsUserId = null;

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    sidebar.classList.toggle('open');
    mainContent.classList.toggle('sidebar-open');
}

function toggleUserStatus(userId) {
    fetch(`/admin/users/${userId}/toggle_status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // –î–∏–Ω–∞–º—ñ—á–Ω–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            updateUserStatusUI(userId);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å—Ç–∞—Ç—É—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞', 'error');
    });
}

function updateUserStatusUI(userId) {
    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ä—è–¥–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    const row = document.querySelector(`tr:has(button[onclick*="toggleUserStatus(${userId})"])`);
    if (!row) return;
    
    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –∫–æ–º—ñ—Ä–∫—É —Å—Ç–∞—Ç—É—Å—É
    const statusCell = row.querySelectorAll('.col-budget')[0]; // –ü–µ—Ä—à–∞ col-budget - —Ü–µ —Å—Ç–∞—Ç—É—Å
    if (!statusCell) return;
    
    const statusBadge = statusCell.querySelector('.status-badge');
    const isActive = statusBadge?.textContent.includes('–ê–∫—Ç–∏–≤–Ω–∏–π');
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å (—ñ–Ω–≤–µ—Ä—Ç—É—î–º–æ)
    if (isActive) {
        statusCell.innerHTML = `
            <span class="status-badge" style="background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;">
                <i class="fas fa-times-circle"></i>
                <span>–î–µ–∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∏–π</span>
            </span>
        `;
    } else {
        statusCell.innerHTML = `
            <span class="status-badge" style="background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1;">
                <i class="fas fa-check-circle"></i>
                <span>–ê–∫—Ç–∏–≤–Ω–∏–π</span>
            </span>
        `;
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É –¥—ñ—ó
    const actionBtn = row.querySelector(`button[onclick*="toggleUserStatus(${userId})"]`);
    if (actionBtn) {
        if (isActive) {
            // –°—Ç–∞–≤ –¥–µ–∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∏–º - –ø–æ–∫–∞–∑—É—î–º–æ –∑–µ–ª–µ–Ω—É –∫–Ω–æ–ø–∫—É –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó
            actionBtn.className = 'action-btn success';
            actionBtn.title = '–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏';
            actionBtn.innerHTML = '<i class="fas fa-check"></i>';
        } else {
            // –°—Ç–∞–≤ –∞–∫—Ç–∏–≤–Ω–∏–º - –ø–æ–∫–∞–∑—É—î–º–æ –∂–æ–≤—Ç—É –∫–Ω–æ–ø–∫—É –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó
            actionBtn.className = 'action-btn warning';
            actionBtn.title = '–î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏';
            actionBtn.innerHTML = '<i class="fas fa-ban"></i>';
        }
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateUserStatCards();
}

function unlockUser(userId) {
    if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?')) {
        return;
    }
    
    fetch(`/admin/users/${userId}/unlock`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // –í–∏–¥–∞–ª—è—î–º–æ —ñ–∫–æ–Ω–∫—É –∑–∞–º–∫–∞ —ñ –∫–Ω–æ–ø–∫—É —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è
            const row = document.querySelector(`tr:has(button[onclick*="unlockUser(${userId})"])`);
            if (row) {
                // –í–∏–¥–∞–ª—è—î–º–æ —ñ–∫–æ–Ω–∫—É –∑–∞–º–∫–∞ –±—ñ–ª—è —ñ–º–µ–Ω—ñ
                const lockIcon = row.querySelector('.fas.fa-lock');
                if (lockIcon) {
                    lockIcon.remove();
                }
                
                // –í–∏–¥–∞–ª—è—î–º–æ –∫–Ω–æ–ø–∫—É —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è
                const unlockBtn = row.querySelector(`button[onclick*="unlockUser(${userId})"]`);
                if (unlockBtn) {
                    unlockBtn.style.transition = 'opacity 0.3s ease';
                    unlockBtn.style.opacity = '0';
                    setTimeout(() => unlockBtn.remove(), 300);
                }
            }
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞', 'error');
    });
}

function deleteUser(userId, username) {
    if (!confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ "${username}"? –¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏!`)) {
        return;
    }
    
    fetch(`/admin/users/${userId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // –ü–ª–∞–≤–Ω–æ –≤–∏–¥–∞–ª—è—î–º–æ —Ä—è–¥–æ–∫ –∑ —Ç–∞–±–ª–∏—Ü—ñ
            const row = document.querySelector(`tr:has(button[onclick*="deleteUser(${userId},"])`);
            if (row) {
                row.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                row.style.opacity = '0';
                row.style.transform = 'translateX(-20px)';
                
                setTimeout(() => {
                    row.remove();
                    updateUserStatCards();
                }, 300);
            }
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞', 'error');
    });
}

function updateUserStatCards() {
    // –ü–µ—Ä–µ—Ä–∞—Ö–æ–≤—É—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const allRows = document.querySelectorAll('.leads-table tbody tr');
    let totalUsers = allRows.length;
    let activeUsers = 0;
    let agents = 0;
    let admins = 0;
    
    allRows.forEach(row => {
        // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏—Ö
        const statusBadge = row.querySelectorAll('.col-budget')[0]?.querySelector('.status-badge');
        if (statusBadge && statusBadge.textContent.includes('–ê–∫—Ç–∏–≤–Ω–∏–π')) {
            activeUsers++;
        }
        
        // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ –∞–≥–µ–Ω—Ç—ñ–≤ —ñ –∞–¥–º—ñ–Ω—ñ–≤
        const roleBadge = row.querySelector('.col-status .status-badge');
        if (roleBadge) {
            if (roleBadge.textContent.includes('–ê–≥–µ–Ω—Ç')) {
                agents++;
            } else if (roleBadge.textContent.includes('–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä')) {
                admins++;
            }
        }
    });
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –∫–∞—Ä—Ç–∫–∏
    const statsCards = document.querySelectorAll('.stats-card h4');
    if (statsCards[0]) statsCards[0].textContent = totalUsers; // –í—Å—å–æ–≥–æ
    if (statsCards[1]) statsCards[1].textContent = activeUsers; // –ê–∫—Ç–∏–≤–Ω–∏—Ö
    if (statsCards[2]) statsCards[2].textContent = agents; // –ê–≥–µ–Ω—Ç—ñ–≤
    if (statsCards[3]) statsCards[3].textContent = admins; // –ê–¥–º—ñ–Ω—ñ–≤
}

function openCommissionModal(userId, username, currentCommission) {
    currentUserId = userId;
    document.getElementById('modalUsername').textContent = username;
    document.getElementById('commissionInput').value = currentCommission;
    document.getElementById('commissionModal').style.display = 'flex';
    
    // –§–æ–∫—É—Å –Ω–∞ input
    setTimeout(() => {
        document.getElementById('commissionInput').focus();
        document.getElementById('commissionInput').select();
    }, 100);
}

function closeCommissionModal() {
    document.getElementById('commissionModal').style.display = 'none';
    currentUserId = null;
}

function setCommissionValue(value) {
    document.getElementById('commissionInput').value = value;
}

function saveCommission() {
    const commission = document.getElementById('commissionInput').value;
    
    if (commission === '' || isNaN(commission)) {
        showNotification('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ–º—ñ—Å—ñ—ó', 'error');
        return;
    }
    
    const commissionNum = parseFloat(commission);
    if (commissionNum < 0 || commissionNum > 100) {
        showNotification('–ö–æ–º—ñ—Å—ñ—è –º–∞—î –±—É—Ç–∏ –≤—ñ–¥ 0% –¥–æ 100%', 'error');
        return;
    }
    
    fetch(`/admin/users/${currentUserId}/commission`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ commission: commissionNum })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–º—ñ—Å—ñ—ó –≤ —Ç–∞–±–ª–∏—Ü—ñ
            const commissionCell = document.getElementById(`commission-${currentUserId}`);
            if (commissionCell) {
                commissionCell.innerHTML = `<strong style="color: var(--sidebar-primary); font-size: 1rem;">${data.commission}%</strong>`;
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ–º—ñ—Å—ñ—ó –≤ –∫–Ω–æ–ø—Ü—ñ (–¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–∫–∏)
            const buttons = document.querySelectorAll(`button[onclick*="openCommissionModal(${currentUserId}"]`);
            buttons.forEach(button => {
                const username = document.getElementById('modalUsername').textContent;
                button.setAttribute('onclick', `openCommissionModal(${currentUserId}, '${username}', ${data.commission})`);
            });
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ –º–æ–¥–∞–ª—Ü—ñ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ—ó —Å–µ—Å—ñ—ó
            document.getElementById('commissionInput').value = data.commission;
            
            closeCommissionModal();
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –∫–æ–º—ñ—Å—ñ—ó', 'error');
    });
}

// ===== –§–£–ù–ö–¶–Ü–á –î–õ–Ø –†–û–ë–û–¢–ò –ó –î–û–ö–£–ú–ï–ù–¢–ê–ú–ò =====
function openDocumentsModal(userId, username) {
    currentDocumentsUserId = userId;
    document.getElementById('documentsUsername').textContent = username;
    document.getElementById('documentsModal').style.display = 'flex';
    
    // –û—á–∏—â–∞—î–º–æ —Ñ–æ—Ä–º—É
    clearSelectedFile();
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤
    loadDocuments(userId);
}

function closeDocumentsModal() {
    document.getElementById('documentsModal').style.display = 'none';
    currentDocumentsUserId = null;
    clearSelectedFile();
}

function updateFileName() {
    const fileInput = document.getElementById('documentFile');
    const fileNameSpan = document.getElementById('selectedFileName');
    const clearBtn = document.getElementById('clearFileBtn');
    
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const fileName = file.name;
        const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
        
        fileNameSpan.innerHTML = `<strong style="color: var(--sidebar-text);">${fileName}</strong> <span style="color: var(--sidebar-text-muted);">(${fileSize} MB)</span>`;
        fileNameSpan.style.fontStyle = 'normal';
        clearBtn.style.display = 'inline-block';
    } else {
        clearSelectedFile();
    }
}

function clearSelectedFile() {
    const fileInput = document.getElementById('documentFile');
    const fileNameSpan = document.getElementById('selectedFileName');
    const clearBtn = document.getElementById('clearFileBtn');
    
    fileInput.value = '';
    fileNameSpan.textContent = '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
    fileNameSpan.style.fontStyle = 'italic';
    clearBtn.style.display = 'none';
}

function loadDocuments(userId) {
    const contentDiv = document.getElementById('documentsListContent');
    contentDiv.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: var(--sidebar-text-muted);">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p style="margin-top: 1rem;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
        </div>
    `;
    
    fetch(`/admin/users/${userId}/documents`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.documents.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--sidebar-text-muted);">
                            <i class="fas fa-folder-open fa-3x" style="opacity: 0.3;"></i>
                            <p style="margin-top: 1rem;">–ù–µ–º–∞—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</p>
                        </div>
                    `;
                } else {
                    let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
                    data.documents.forEach(doc => {
                        const fileIcon = getFileIcon(doc.file_type);
                        const fileSize = formatFileSize(doc.file_size);
                        
                        html += `
                            <div class="document-item" style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: white; border: 1px solid #e2e8f0; border-radius: 8px;">
                                <div style="font-size: 1.5rem; color: var(--sidebar-primary); width: 2rem; text-align: center;">
                                    <i class="fas fa-${fileIcon}"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 500; color: var(--sidebar-text); margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        ${doc.filename}
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--sidebar-text-muted);">
                                        ${fileSize} ‚Ä¢ ${doc.uploaded_at} ‚Ä¢ ${doc.uploader_name}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="action-btn success" onclick="downloadDocument(${doc.id})" title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="action-btn danger" onclick="deleteDocument(${userId}, ${doc.id}, '${doc.filename}')" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    contentDiv.innerHTML = html;
                }
            } else {
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        <i class="fas fa-exclamation-circle fa-2x"></i>
                        <p style="margin-top: 1rem;">${data.message}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            contentDiv.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #ef4444;">
                    <i class="fas fa-exclamation-circle fa-2x"></i>
                    <p style="margin-top: 1rem;">–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</p>
                </div>
            `;
        });
}

function saveDocumentChanges() {
    console.log('üöÄ === FRONTEND: –ü–û–ß–ê–¢–û–ö –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø ===');
    
    const fileInput = document.getElementById('documentFile');
    const file = fileInput.files[0];
    
    console.log('üìã –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–∞–π–ª—É:', {
        fileSelected: !!file,
        fileName: file ? file.name : '–Ω–µ–º–∞—î',
        fileSize: file ? file.size : 0,
        fileType: file ? file.type : '–Ω–µ–º–∞—î'
    });
    
    // –Ø–∫—â–æ —Ñ–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ - –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É
    if (!file) {
        console.log('‚ÑπÔ∏è –§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ, –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É');
        closeDocumentsModal();
        return;
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–º—ñ—Ä—É —Ñ–∞–π–ª—É (–º–∞–∫—Å 10MB)
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
        console.error('‚ùå –§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π:', (file.size / 1024 / 1024).toFixed(2), 'MB');
        showNotification('–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä: 10MB', 'error');
        return;
    }
    
    console.log('‚úÖ –§–∞–π–ª –ø—Ä–æ–π—à–æ–≤ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —Ä–æ–∑–º—ñ—Ä—É');
    
    // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    const saveBtn = event.target;
    const originalBtnText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
    
    const formData = new FormData();
    formData.append('file', file);
    
    console.log('üì§ FormData —Å—Ç–≤–æ—Ä–µ–Ω–æ, –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç...');
    console.log('   URL:', `/admin/users/${currentDocumentsUserId}/documents`);
    console.log('   User ID:', currentDocumentsUserId);
    
    fetch(`/admin/users/${currentDocumentsUserId}/documents`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('üì• –û—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞:', {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok
        });
        return response.json();
    })
    .then(data => {
        console.log('üìä –î–∞–Ω—ñ –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:', data);
        
        if (data.success) {
            console.log('‚úÖ –£—Å–ø—ñ—Ö! –î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
            showNotification('‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –≤ S3!', 'success');
            
            // –û—á–∏—â–∞—î–º–æ —Ñ–æ—Ä–º—É
            clearSelectedFile();
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤
            console.log('üîÑ –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤...');
            loadDocuments(currentDocumentsUserId);
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–∫–æ–Ω–∫—É –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –≤ —Ç–∞–±–ª–∏—Ü—ñ
            console.log('üîÑ –û–Ω–æ–≤–ª—é—î–º–æ —ñ–∫–æ–Ω–∫—É –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤...');
            updateDocumentButtonIcon(currentDocumentsUserId);
        } else {
            console.error('‚ùå –°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É:', data.message);
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('‚ùå‚ùå‚ùå –ü–û–ú–ò–õ–ö–ê FETCH ‚ùå‚ùå‚ùå');
        console.error('   –¢–∏–ø –ø–æ–º–∏–ª–∫–∏:', error.name);
        console.error('   –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', error.message);
        console.error('   Stack:', error.stack);
        showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç—É', 'error');
    })
    .finally(() => {
        console.log('üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è –æ–ø–µ—Ä–∞—Ü—ñ—ó');
        // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalBtnText;
    });
}

function deleteDocument(userId, docId, filename) {
    if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç "${filename}"?`)) {
        return;
    }
    
    fetch(`/admin/users/${userId}/documents/${docId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            loadDocuments(userId);
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–∫–æ–Ω–∫—É –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –≤ —Ç–∞–±–ª–∏—Ü—ñ
            updateDocumentButtonIcon(userId);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç—É', 'error');
    });
}

function downloadDocument(docId) {
    window.open(`/documents/${docId}/download`, '_blank');
}

function updateDocumentButtonIcon(userId) {
    console.log('üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–∫–æ–Ω–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –¥–ª—è userId:', userId);
    
    fetch(`/admin/users/${userId}/documents`)
        .then(response => response.json())
        .then(data => {
            console.log('üìä –û—Ç—Ä–∏–º–∞–Ω–æ –¥–∞–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤:', data);
            
            if (data.success) {
                const docCount = data.documents.length;
                console.log('üìÅ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤:', docCount);
                
                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –∫–Ω–æ–ø–∫—É –∑–∞ data-–∞—Ç—Ä–∏–±—É—Ç–æ–º
                const button = document.querySelector(`button[data-user-id="${userId}"][data-doc-button="true"]`);
                console.log('üîò –ö–Ω–æ–ø–∫–∞ –∑–Ω–∞–π–¥–µ–Ω–∞:', !!button);
                
                if (button) {
                    console.log('   –ö–ª–∞—Å–∏ –∫–Ω–æ–ø–∫–∏ –î–û –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:', button.className);
                    
                    // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –∫–ª–∞—Å–∏
                    button.classList.remove('success', 'danger');
                    
                    // –î–æ–¥–∞—î–º–æ –Ω–æ–≤–∏–π –∫–ª–∞—Å
                    const newClass = docCount > 0 ? 'success' : 'danger';
                    button.classList.add(newClass);
                    button.title = `–î–æ–∫—É–º–µ–Ω—Ç–∏ (${docCount})`;
                    
                    console.log(`‚úÖ –Ü–∫–æ–Ω–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–∞: ${newClass} (${docCount} –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤)`);
                    console.log('   –ö–ª–∞—Å–∏ –∫–Ω–æ–ø–∫–∏ –ü–Ü–°–õ–Ø –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:', button.className);
                } else {
                    console.error('‚ùå –ö–Ω–æ–ø–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è userId:', userId);
                    console.error('   –ü–µ—Ä–µ–≤—ñ—Ä—è—é –≤—Å—ñ –∫–Ω–æ–ø–∫–∏ –∑ data-doc-button:', document.querySelectorAll('[data-doc-button]').length);
                }
            } else {
                console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:', data.message);
            }
        })
        .catch(error => {
            console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ fetch:', error);
        });
}

function getFileIcon(fileType) {
    if (!fileType) return 'file';
    if (fileType.includes('pdf')) return 'file-pdf';
    if (fileType.includes('word') || fileType.includes('document')) return 'file-word';
    if (fileType.includes('image') || fileType.includes('jpeg') || fileType.includes('png')) return 'file-image';
    if (fileType.includes('text')) return 'file-alt';
    return 'file';
}

function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

// –ù–∞—Ç–∏—Å–∫–∞–Ω–Ω—è Enter –≤ input
document.addEventListener('DOMContentLoaded', function() {
    const commissionInput = document.getElementById('commissionInput');
    if (commissionInput) {
        commissionInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveCommission();
            }
        });
    }
    
    // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–∫–∏ –ø–æ Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeCommissionModal();
        }
    });
});

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle';
    
    notification.innerHTML = `
        <i class="fas ${icon} notification-icon"></i>
        <div class="notification-content">${message}</div>
        <button class="notification-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
        <div class="notification-progress"></div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}
</script>
{% endblock %}
